---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Header from "../components/Header.astro";

type Props = {
	prevPost?: CollectionEntry<"blog"> | null;
	nextPost?: CollectionEntry<"blog"> | null;
	relatedPosts?: CollectionEntry<"blog">[];
} & CollectionEntry<"blog">["data"];

const {
	title,
	description,
	pubDate,
	updatedDate,
	image,
	tags,
	author,
	prevPost,
	nextPost,
	relatedPosts,
} = Astro.props;
---

<html lang="fr">
	<head>
		<BaseHead title={title} description={description} image={image?.src} />
	</head>

	<body class="min-h-screen">
		<Header />
		<main class="max-w-4xl mx-auto px-4 py-12 md:py-20">
			<article>
				{
					image && (
						<div class="w-full h-64 md:h-80 overflow-hidden">
							<Image
								width={1020}
								height={510}
								src={image.src}
								alt={image.alt || ""}
								class="w-full h-full object-cover"
								loading="eager"
								fetchpriority="high"
							/>
						</div>
					)
				}
				<div class="p-6 md:p-8">
					<header class="mb-8">
						<h1
							class="text-3xl md:text-4xl font-bold mb-4 text-black"
						>
							{title}
						</h1>
						{
							tags && tags.length > 0 && (
								<div class="flex flex-wrap gap-2 mb-6">
									{tags.map((tag) => (
										<a
											href={`/blog/tag/${encodeURIComponent(tag)}/`}
											class="px-3 py-1 bg-gray-200 text-gray-800 rounded-full text-sm hover:bg-accent hover:text-white transition-all duration-200 no-underline"
										>
											#{tag}
										</a>
									))}
								</div>
							)
						}
						<hr class="border-gray-200" />
					</header>
					<div class="prose max-w-none">
						<slot />
					</div>
					<footer
						class="mt-12 pt-6 border-t border-gray-200 text-gray-600 text-sm"
					>
						<p>
							Publié le <FormattedDate date={pubDate} />{
								author && ` par ${author}`
							}
						</p>
						{
							tags && tags.length > 0 && (
								<p class="mt-2">
									Étiquettes :{" "}
									{tags.map((tag) => `#${tag}`).join(", ")}
								</p>
							)
						}
					</footer>
				</div>
			</article>

			<!-- Related Posts -->
			{
				relatedPosts && relatedPosts.length > 0 && (
					<section class="mt-16">
						<h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-8">
							Articles similaires
						</h2>
						<!-- Mobile carousel / Desktop grid -->
						<div class="flex overflow-x-auto snap-x snap-mandatory gap-4 -mx-4 px-4 pb-2 scrollbar-hide md:grid md:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 md:gap-6 md:mx-0 md:px-0 md:pb-0">
							{
								relatedPosts.map((post) => {
									const sharedTags = post.data.tags?.filter((tag) =>
										tags?.includes(tag)
									);

									return (
										<a
											href={`/blog/${post.id}`}
											class="group flex flex-col bg-white rounded-xl overflow-hidden border border-gray-100 hover:border-gray-200 hover:shadow-sm transition-all duration-200 flex-shrink-0 w-80 snap-center md:w-auto md:flex-shrink-1"
										>
											{/* Thumbnail */}
											{post.data.image?.src && (
												<div class="w-full h-36 overflow-hidden bg-gray-50">
													<Image
														width={400}
														height={250}
														src={post.data.image.src}
														alt={
															post.data.image.alt || post.data.title
														}
														class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
														loading="lazy"
													/>
												</div>
											)}

											{/* Content */}
											<div class="p-5 flex flex-col flex-1">
												<h3 class="text-base font-bold text-gray-900 mb-3 line-clamp-2 group-hover:text-accent transition-colors">
													{post.data.title}
												</h3>

												{/* Shared tags */}
												{sharedTags && sharedTags.length > 0 && (
													<div class="mt-auto flex flex-wrap gap-1.5">
														{sharedTags.slice(0, 2).map((tag) => (
															<span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600 font-medium">
																#{tag}
															</span>
														))}
													</div>
												)}
											</div>
										</a>
									);
								})
							}
						</div>
					</section>
				)
			}

			<!-- Article Navigation -->
			<nav class="mt-16 pt-8 border-t border-gray-200">
				<div class="flex items-center justify-between gap-4">
					<!-- Previous Article -->
					<div class="flex-1 min-w-0">
						{
							prevPost ? (
								<a
									href={`/blog/${prevPost.id}`}
									class="group flex items-center gap-3 py-3 px-4 -ml-4 rounded-xl hover:bg-gray-100 transition-all duration-200"
								>
									<span class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 group-hover:bg-accent group-hover:text-white transition-all duration-200">
										<svg
											xmlns="http://www.w3.org/2000/svg"
											class="w-5 h-5"
											fill="none"
											viewBox="0 0 24 24"
											stroke="currentColor"
											stroke-width="2"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												d="M15 19l-7-7 7-7"
											/>
										</svg>
									</span>
									<span class="hidden sm:block text-sm font-medium text-gray-600 group-hover:text-accent truncate transition-colors duration-200">
										{prevPost.data.title}
									</span>
								</a>
							) : (
								<div class="w-10 h-10" />
							)
						}
					</div>

					<!-- Next Article -->
					<div class="flex-1 min-w-0 flex justify-end">
						{
							nextPost ? (
								<a
									href={`/blog/${nextPost.id}`}
									class="group flex items-center gap-3 py-3 px-4 -mr-4 rounded-xl hover:bg-gray-100 transition-all duration-200"
								>
									<span class="hidden sm:block text-sm font-medium text-gray-600 group-hover:text-accent truncate transition-colors duration-200 text-right">
										{nextPost.data.title}
									</span>
									<span class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 group-hover:bg-accent group-hover:text-white transition-all duration-200">
										<svg
											xmlns="http://www.w3.org/2000/svg"
											class="w-5 h-5"
											fill="none"
											viewBox="0 0 24 24"
											stroke="currentColor"
											stroke-width="2"
										>
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												d="M9 5l7 7-7 7"
											/>
										</svg>
									</span>
								</a>
							) : (
								<div class="w-10 h-10" />
							)
						}
					</div>
				</div>

				<!-- Back to Articles -->
				<div class="mt-6 text-center">
					<a
						href="/blog"
						class="text-sm font-medium text-gray-500 hover:text-accent transition-colors duration-200"
					>
						Voir tous les articles
					</a>
				</div>
			</nav>
		</main>
		<Footer />
	</body>
</html>

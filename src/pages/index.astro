---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import FormattedDate from "../components/FormattedDate.astro";
import { SITE_DESCRIPTION, SITE_TITLE, SITE_AUTHOR } from "../consts";

const allPosts = await getCollection("blog");
const featuredPosts = allPosts
	.filter((post) => !post.data.draft)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 3);

// Count tags across all posts
const tagCounts = new Map<string, number>();
for (const post of allPosts) {
	if (post.data.tags) {
		for (const tag of post.data.tags) {
			tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
		}
	}
}

// Get top 3 tags
const topTags = Array.from(tagCounts.entries())
	.sort((a, b) => b[1] - a[1])
	.slice(0, 3)
	.map(([tag, count]) => ({ tag, count }));
---

<!doctype html>
<html lang="fr">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body class="min-h-screen">
		<Header />
		<main class="max-w-6xl mx-auto px-4 py-12 md:py-16">
			<!-- Hero section -->
			<section class="text-center mb-24">
				<h1
					class="text-5xl md:text-6xl font-extrabold mb-8 text-black tracking-tight"
				>
					{SITE_TITLE}
				</h1>
				<p
					class="text-xl text-gray-700 max-w-2xl mx-auto mb-12 leading-relaxed"
				>
					{SITE_DESCRIPTION}
				</p>
			</section>

			<!-- Featured posts -->
			<section class="mb-24">
				<h2 class="text-3xl font-extrabold mb-10 text-black">
					Articles récents
				</h2>
				<div
					class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-16"
				>
					{
						featuredPosts.map((post, index) => {
							const imageSrc = post.data.image?.src;
							const imageAlt = post.data.image?.alt || "";
							return (
								<article class="group relative flex flex-col">
									<a
										href={`/blog/${post.id}/`}
										class="block no-underline"
									>
										{imageSrc && (
											<div class="w-full h-56 mb-6 overflow-hidden rounded-xl">
												<Image
													width={400}
													height={250}
													src={imageSrc}
													alt={imageAlt}
													class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
													loading="eager"
													decoding="sync"
												/>
											</div>
										)}
										<div class="">
											<h3 class="text-xl font-extrabold mb-3 text-black group-hover:text-accent transition-colors">
												{post.data.title}
											</h3>
											<p class="text-gray-500 mb-4 text-sm font-medium italic">
												<FormattedDate
													date={post.data.pubDate}
												/>
												{post.data.author &&
													` • ${post.data.author}`}
											</p>
										</div>
									</a>
								</article>
							);
						})
					}
				</div>
				{
					featuredPosts.length === 0 ? (
						<p class="text-center text-gray-600 py-12">
							Aucun article publié pour le moment.
						</p>
					) : (
						<div class="text-center mt-10">
							<a
								href="/blog"
								class="inline-flex items-center text-accent hover:text-accent-dark font-medium"
							>
								Voir tous les articles
								<svg
									class="ml-2 w-5 h-5"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
									xmlns="http://www.w3.org/2000/svg"
								>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M14 5l7 7m0 0l-7 7m7-7H3"
									/>
								</svg>
							</a>
						</div>
					)
				}
			</section>

			<!-- Topics section -->
			<section class="py-16 border-t border-gray-200">
				<div class="max-w-4xl mx-auto text-center">
					<h2 class="text-3xl font-extrabold mb-12 text-black">
						Explorez par sujet
					</h2>
					<div class="flex flex-wrap justify-center gap-4">
						{
							topTags.map(({ tag, count }) => (
								<a
									href={`/blog/tag/${encodeURIComponent(tag)}/`}
									class="group inline-flex flex-col items-center px-8 py-6 bg-gray-50 hover:bg-accent/10 rounded-xl transition-all duration-300 hover:scale-105 hover:shadow-lg border border-gray-200 hover:border-accent/30"
								>
									<span class="text-2xl font-extrabold text-gray-900 group-hover:text-accent mb-2 transition-colors">
										{tag}
									</span>
									<span class="text-sm font-medium text-gray-500">
										{count} {count === 1 ? 'article' : 'articles'}
									</span>
								</a>
							))
						}
					</div>
				</div>
			</section>
		</main>
		<Footer />
	</body>
</html>
